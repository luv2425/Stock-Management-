<!DOCTYPE html> 
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Billing / POS</title>
  <!-- jsPDF for PDF invoice -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background:#f4f4f4; }
    h1{ color:#096ae9}h2,h3{ color:#333 }
    table{ width:100%; border-collapse:collapse; margin-top:12px }
    th,td{ border:1px solid #ddd; padding:8px; text-align:left }
    th{ background:#007bff; color:#fff }
    tr:nth-child(even){ background:#f2f2f2 }
    label{ display:block; margin:8px 0 4px }
    input,select,button{ padding:8px; margin-bottom:8px; max-width:320px }
    button{ background:#28a745; color:#fff; border:none; cursor:pointer }
    button:hover{ background:#218838 }
    .delete-btn{ background:#dc3545 }
    .cart-btn{ background:#ffc107; color:#000 }
    .controls { display:flex; gap:12px; align-items:flex-end; flex-wrap:wrap }
    .small { max-width:140px }

    /* ðŸŒˆ Pretty navbar (same style as stock page) */
    .nav {
      display: flex;
      justify-content: center;
      gap: 16px;
      flex-wrap: wrap;
      background: #ffffff;
      padding: 14px 20px;
      border-radius: 14px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      margin-bottom: 24px;
    }
    .nav a {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      text-decoration: none;
      font-weight: 600;
      color: #fff;
      padding: 8px 18px;
      border-radius: 999px;
      font-size: 15px;
      transition: transform 0.15s ease, box-shadow 0.15s ease, opacity 0.15s ease;
    }
    .nav a.dashboard { background:#0d6efd; }        /* blue */
    .nav a.stock     { background:#198754; }        /* green */
    .nav a.billing   { background:#ffc107; color:#000; } /* yellow */
    .nav a.reports   { background:#dc3545; }        /* red */
    .nav a:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 8px rgba(0,0,0,0.18);
      opacity: 0.95;
    }
    .nav a.active {
      box-shadow: 0 0 0 3px #ffffff, 0 0 0 5px rgba(0,0,0,0.08);
    }

    /* suggestion dropdown styling */
    .suggestions {
      list-style:none;
      margin:0;
      padding:0;
      max-width:320px;
      border:1px solid #ddd;
      background:#fff;
      position:absolute;
      z-index:10;
      max-height:180px;
      overflow-y:auto;
      display:none;
    }
    .suggestions li {
      padding:6px 8px;
      cursor:pointer;
    }
    .suggestions li:hover {
      background:#f0f0f0;
    }
    .field-wrapper{
      position:relative; /* for suggestions absolute positioning */
      display:inline-block;
    }
  </style>
</head>
<body>
  <!-- Navigation (updated to pill style) -->
  <div class="nav">
    <a href="dashboard.html" class="dashboard">ðŸ“Š Dashboard</a>
    <a href="stock.html" class="stock">ðŸ“¦ Stock</a>
    <a href="billing.html" class="billing">ðŸ§¾ Billing</a>
    <a href="reports.html" class="reports">ðŸ“ˆ Reports</a>
  </div>
  <h1>ðŸ§¾ Billing / POS</h1>

  <p><strong>Note:</strong> Make sure you have added products in the <em>Stock</em> page.</p>

  <!-- Customer Details -->
  <h2>Customer Details</h2>
  <label for="custName">Customer Name</label>
  <input id="custName" type="text" placeholder="Optional" />

  <label for="custPhone">Phone</label>
  <input id="custPhone" type="text" placeholder="Optional" />

  <label for="custEmail">Email</label>
  <input id="custEmail" type="email" placeholder="Optional" />

  <!-- Product Search -->
  <h2>Add Items</h2>
  <label for="productSearch">Search Product</label>

  <!-- wrapper + suggestions list -->
  <div class="field-wrapper">
    <input id="productSearch" type="text" placeholder="Type product name..." class="small" />
    <ul id="productSuggestions" class="suggestions"></ul>
  </div>

  <!-- editable unit price -->
  <label for="unitPrice">Unit Price (â‚¹)</label>
  <input id="unitPrice" type="number" min="0" step="0.01" class="small" />

  <label for="billQty">Quantity</label>
  <input id="billQty" type="number" min="0" step="any" class="small" />

  <div class="controls">
    <button id="addToCartBtn" type="button" class="cart-btn">Add to Cart</button>
  </div>

  <!-- Cart Table -->
  <table id="cartTable">
    <thead><tr><th>Product</th><th>Qty</th><th>Unit Price</th><th>Subtotal</th><th>Remove</th></tr></thead>
    <tbody></tbody>
  </table>

  <!-- Discount / Tax -->
  <label for="discount">Discount (%)</label>
  <input id="discount" type="number" value="0" class="small" />

  <label for="tax">Tax (%)</label>
  <input id="tax" type="number" value="0" class="small" />

  <h3 id="totalAmount">Total: â‚¹0.00</h3>
  <div class="controls">
    <button id="checkoutBtn" type="button">Checkout & Generate Invoice</button>
  </div>

  <script>
    const { jsPDF } = window.jspdf || {};

    // ---- Shared storage helpers ----
    const STORAGE_KEYS = {
      PRODUCTS: 'sbm_products',
      SALES: 'sbm_sales'
    };

    function loadProducts() {
      try { return JSON.parse(localStorage.getItem(STORAGE_KEYS.PRODUCTS)) || []; }
      catch (e) { return []; }
    }

    function saveProducts() {
      localStorage.setItem(STORAGE_KEYS.PRODUCTS, JSON.stringify(products));
    }

    function loadSales() {
      try { return JSON.parse(localStorage.getItem(STORAGE_KEYS.SALES)) || []; }
      catch (e) { return []; }
    }

    function saveSales() {
      localStorage.setItem(STORAGE_KEYS.SALES, JSON.stringify(sales));
    }

    // ---- DOM ----
    const custNameInput = document.getElementById('custName');
    const custPhoneInput = document.getElementById('custPhone');
    const custEmailInput = document.getElementById('custEmail');
    const productSearchInput = document.getElementById('productSearch');
    const productSuggestions = document.getElementById('productSuggestions');
    const unitPriceInput = document.getElementById('unitPrice');
    const billQtyInput = document.getElementById('billQty');
    const addToCartBtn = document.getElementById('addToCartBtn');
    const cartTableBody = document.querySelector('#cartTable tbody');
    const discountInput = document.getElementById('discount');
    const taxInput = document.getElementById('tax');
    const totalAmountDisplay = document.getElementById('totalAmount');
    const checkoutBtn = document.getElementById('checkoutBtn');

    // ---- Data ----
    let products = loadProducts();
    let sales = loadSales();
    let cart = [];
    let alert100Shown = false;
    let alert50Shown = false;
    let selectedProductId = null; // track selected product

    function formatCurrency(v){ return "â‚¹" + Number(v).toFixed(2); }

    function escapeHtml(str){
      return String(str)
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;');
    }

    // build suggestion list when typing
    productSearchInput.addEventListener('input', function () {
      const query = productSearchInput.value.trim().toLowerCase();
      products = loadProducts();
      selectedProductId = null; // reset

      if (!query) {
        productSuggestions.innerHTML = "";
        productSuggestions.style.display = "none";
        return;
      }

      const matches = products
        .filter(p => p.name.toLowerCase().includes(query) || p.category.toLowerCase().includes(query))
        .slice(0, 10); // limit

      if (matches.length === 0) {
        productSuggestions.innerHTML = "";
        productSuggestions.style.display = "none";
        return;
      }

      productSuggestions.innerHTML = "";
      matches.forEach(p => {
        const li = document.createElement('li');
        li.textContent = `${p.name} (${p.category})`;
        li.dataset.id = p.id;
        li.addEventListener('click', () => {
          selectedProductId = p.id;
          productSearchInput.value = p.name;      // fill name
          unitPriceInput.value = p.price;         // auto-fill price
          productSuggestions.innerHTML = "";
          productSuggestions.style.display = "none";
          billQtyInput.focus();
        });
        productSuggestions.appendChild(li);
      });
      productSuggestions.style.display = "block";
    });

    // hide suggestions on click outside
    document.addEventListener('click', function(e){
      if (!productSuggestions.contains(e.target) && e.target !== productSearchInput) {
        productSuggestions.style.display = "none";
      }
    });

    // Add to cart using product name search (with editable price)
    addToCartBtn.addEventListener('click', function(){
      products = loadProducts(); // refresh in case stock updated in another tab
      const query = productSearchInput.value.trim().toLowerCase();
      const qty = Number(billQtyInput.value);

      if (!query || !isFinite(qty) || qty <= 0) {
        alert("Enter a product name and quantity");
        return;
      }

      // Prefer selected product (from suggestions), otherwise first match
      let p = null;
      if (selectedProductId) {
        p = products.find(pr => pr.id === selectedProductId);
      }
      if (!p) {
        const matches = products.filter(pr => pr.name.toLowerCase().includes(query));
        if (matches.length === 0) {
          alert("Product not found in stock");
          return;
        }
        p = matches[0];
      }

      if (qty > p.quantity) {
        alert("Quantity exceeds stock");
        return;
      }

      // allow custom price override
      let priceToUse = p.price;
      const customPrice = parseFloat(unitPriceInput.value);
      if (isFinite(customPrice) && customPrice > 0) {
        priceToUse = customPrice;
      }

      cart.push({ ...p, price: priceToUse, cartQty: qty });
      displayCart();

      // clear inputs for next item
      billQtyInput.value = "";
      productSearchInput.value = "";
      unitPriceInput.value = "";
      selectedProductId = null;
      productSuggestions.innerHTML = "";
      productSuggestions.style.display = "none";
    });

    // Display cart
    function displayCart() {
      cartTableBody.innerHTML = "";
      if (cart.length === 0) {
        cartTableBody.innerHTML =
          "<tr><td colspan='5' style='text-align:center'>Cart is empty</td></tr>";
        totalAmountDisplay.textContent = "Total: â‚¹0.00";
        return;
      }

      let total = 0;
      cart.forEach((item, idx) => {
        const subtotal = Number(item.cartQty) * Number(item.price);
        total += subtotal;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(item.name)}</td>
          <td>${item.cartQty} ${escapeHtml(item.unit)}</td>
          <td>${formatCurrency(item.price)}</td>
          <td>${formatCurrency(subtotal)}</td>
          <td><button type="button" class="delete-btn" onclick="removeFromCart(${idx})">X</button></td>
        `;
        cartTableBody.appendChild(tr);
      });
      totalAmountDisplay.textContent = "Total: " + formatCurrency(total);
    }

    window.removeFromCart = function(idx){
      cart.splice(idx,1);
      displayCart();
    };

    // Checkout
    checkoutBtn.addEventListener('click', function(){
      if (cart.length === 0) {
        alert("Cart is empty");
        return;
      }

      products = loadProducts(); // reload latest
      let total = 0, costTotal = 0;

      cart.forEach(item => {
        total += item.cartQty * item.price;
        costTotal += item.cartQty * (item.cost || 0);
      });

      const discountPct = Number(discountInput.value) || 0;
      const taxPct = Number(taxInput.value) || 0;
      const discountAmt = (total * discountPct) / 100;
      const taxed = (total - discountAmt) * (1 + taxPct / 100);
      const finalAmount = Number(taxed);

      // Keep copy for invoice
      const invoiceItems = cart.map(i => ({
        name: i.name,
        qty: i.cartQty,
        unit: i.unit,
        price: i.price
      }));

      // Update stock quantities
      cart.forEach(item => {
        const p = products.find(x => x.id === item.id);
        if (p) {
          p.quantity = Number(p.quantity) - Number(item.cartQty);
          checkAlerts(p);
        }
      });
      saveProducts();

      // Record sale
      sales.push({
        date: new Date().toISOString(),
        customer: custNameInput.value || "Walk-in",
        phone: custPhoneInput.value || "",
        email: custEmailInput.value || "",
        items: invoiceItems,
        total: finalAmount,
        cost: costTotal
      });
      saveSales();

      // Generate invoice (tabular)
      generateInvoicePDF({
        customer: custNameInput.value || "Walk-in",
        phone: custPhoneInput.value || "",
        email: custEmailInput.value || "",
        items: invoiceItems,
        total: finalAmount,
        discountPct,
        taxPct
      });

      // Clear for next sale
      cart = [];
      displayCart();
      custNameInput.value = "";
      custPhoneInput.value = "";
      custEmailInput.value = "";
      discountInput.value = "0";
      taxInput.value = "0";
      billQtyInput.value = "";
      productSearchInput.value = "";
      unitPriceInput.value = "";
      selectedProductId = null;

      alert("âœ… Checkout complete â€” stock updated and invoice generated.");
    });

    // Invoice PDF - improved tabular layout
    function generateInvoicePDF(data){
      if (jsPDF && typeof jsPDF === "function") {
        const doc = new jsPDF();

        // Title
        doc.setFontSize(14);
        doc.text("Invoice", 105, 12, null, null, "center");

        // Customer details
        doc.setFontSize(10);
        doc.text(`Customer: ${data.customer}`, 10, 22);
        doc.text(`Phone: ${data.phone}`, 10, 28);
        doc.text(`Email: ${data.email}`, 10, 34);

        // Table header
        let y = 46;
        doc.setFontSize(11);
        doc.text("Item",   10,  y);
        doc.text("Qty",    90,  y);
        doc.text("Price", 120,  y);
        doc.text("Total", 160,  y);
        doc.line(10, y + 2, 200, y + 2); // underline header

        y += 8;

        // Table rows
        doc.setFontSize(10);
        data.items.forEach(it => {
          const rowTotal = Number(it.qty) * Number(it.price);

          // New page if needed
          if (y > 260) {
            doc.addPage();
            y = 20;
            doc.setFontSize(11);
            doc.text("Item",   10,  y);
            doc.text("Qty",    90,  y);
            doc.text("Price", 120,  y);
            doc.text("Total", 160,  y);
            doc.line(10, y + 2, 200, y + 2);
            y += 8;
            doc.setFontSize(10);
          }

          // Row data
          doc.text(String(it.name), 10,  y);
          doc.text(`${it.qty} ${it.unit}`, 90,  y);
          doc.text(formatCurrency(it.price), 120, y);
          doc.text(formatCurrency(rowTotal), 160, y);

          y += 7;
        });

        // Summary (discount, tax, total)
        y += 4;
        doc.line(10, y, 200, y);
        y += 8;

        doc.text(`Discount: ${data.discountPct || 0}%`, 10, y);
        y += 6;
        doc.text(`Tax: ${data.taxPct || 0}%`, 10, y);
        y += 8;

        doc.setFontSize(12);
        doc.text(`Grand Total: ${formatCurrency(data.total)}`, 10, y);

        doc.save(`invoice_${Date.now()}.pdf`);
      } else {
        console.log("Invoice data:", data);
        alert("Invoice generated (check console).");
      }
    }

    // Low stock alerts
    function checkAlerts(product){
      const q = Number(product.quantity);
      if (q < 100 && !alert100Shown) {
        alert(`âš ï¸ Warning: ${product.name} stock is below 100 (${product.quantity} ${product.unit})`);
        alert100Shown = true;
      }
      if (q < 50 && !alert50Shown) {
        alert(`â— Critical: ${product.name} stock is below 50 (${product.quantity} ${product.unit})`);
        alert50Shown = true;
      }
    }

    // Initial cart state
    displayCart();

    // Highlight active navbar pill
    document.addEventListener('DOMContentLoaded', function () {
      const current = location.pathname.split('/').pop() || 'billing.html';
      document.querySelectorAll('.nav a').forEach(link => {
        if (link.getAttribute('href') === current) {
          link.classList.add('active');
        }
      });
    });

    /* Enter key moves to next field / triggers action */
    function setupEnterNavigation() {
      const order = [
        custNameInput,     // Enter -> Phone
        custPhoneInput,    // Enter -> Email
        custEmailInput,    // Enter -> Product search
        productSearchInput,// Enter -> Unit price
        unitPriceInput,    // Enter -> Quantity
        billQtyInput,      // Enter -> Add to Cart (click)
        discountInput,     // Enter -> Tax
        taxInput           // Enter -> Checkout (click)
      ];

      order.forEach((el, idx) => {
        if (!el) return;
        el.addEventListener('keydown', function(e){
          if (e.key === 'Enter') {
            e.preventDefault();
            const next = order[idx + 1];

            // From Quantity -> Add to Cart
            if (el === billQtyInput) {
              addToCartBtn.click();
              productSearchInput.focus();
              return;
            }

            // From Tax -> Checkout
            if (el === taxInput) {
              checkoutBtn.click();
              return;
            }

            if (next && typeof next.focus === 'function') {
              next.focus();
            }
          }
        });
      });
    }

    setupEnterNavigation();
  </script>
</body>
</html>
